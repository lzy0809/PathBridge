# Lessons Learned

- 日期：2026-02-27
  - 用户疑问：发布为 DMG 后，是否可以绕过 Finder 工具栏手动拖拽步骤。
  - 暴露问题：容易把“安装包交付形式（DMG）”与“Finder 工具栏交互权限”混为一谈。
  - 预防规则：DMG 仅解决安装分发，不改变 Finder 工具栏定制权限边界；“App 图标直开”首次接入仍需用户在 Finder 自定工具栏中手动拖入。

- 日期：2026-02-27
  - 用户纠正：提示区字号过大且文案过长，导致主窗口操作按钮被挤出可视区域。
  - 暴露问题：把“高可见提示”直接做成大字号多行文本，未校验最小窗口下的布局稳定性。
  - 预防规则：涉及常驻提示区时，先以最小窗口尺寸校验核心按钮可见性；提示文案优先短句，避免路径级长文本。

- 日期：2026-02-27
  - 用户纠正：安装提示不应展示本机绝对路径，文案应固定可理解。
  - 暴露问题：状态提示将调试信息（绝对路径）直接暴露到主界面，降低可读性且噪音过高。
  - 预防规则：主界面文案只保留动作指引，不显示环境细节；调试信息仅放日志，不进主 UI。

- 日期：2026-02-27
  - 用户纠正：Kaku 看似执行成功，但目录并未真正按预期打开。
  - 暴露问题：`kaku cli spawn` 在部分场景会“退出码为 0 但 stderr 报 failed to connect”，导致代码误判为成功。
  - 预防规则：外部终端命令不能只看 `terminationStatus`；对已知“假成功”命令必须同时检查 stderr 特征并做失败判定。

- 日期：2026-02-27
  - 实施纠正：终端选择列表仅展示“已安装”会掩盖能力边界，用户难以理解为何某些终端无法选择。
  - 暴露问题：产品“支持矩阵”与“设置可见项”不一致，弱化了用户对能力范围的认知。
  - 预防规则：设置页默认展示全部支持终端，并对未安装项显式标注，打开失败统一用可读提示反馈，不做静默兜底。

- 日期：2026-02-27
  - 用户纠正：Kaku 能打开但不进入目标目录。
  - 暴露问题：直接走 `open -a/-b Kaku <path>` 并不能稳定把工作目录传递给 Kaku。
  - 预防规则：Kaku 必须优先走官方 CLI（`kaku cli spawn --cwd`），并按模式映射 `--new-window`；GUI `open` 仅作兜底。

- 日期：2026-02-27
  - 用户纠正：窗口体量过大，界面不够精简。
  - 暴露问题：主界面常驻二维码预览和分组容器导致纵向空间膨胀。
  - 预防规则：工具类设置页默认用紧凑表单，非主路径内容（如赞赏码）放到弹窗，窗口尺寸由 `defaultSize + contentSize` 约束。

- 日期：2026-02-27
  - 用户纠正：仅靠“是否安装”判定和少量日志不足以定位终端回落问题，必须跨进程追踪一次请求的完整路径。
  - 暴露问题：之前日志缺少统一 request-id，无法把 Finder 扩展、Host、Launcher、Adapter 的行为串起来看。
  - 预防规则：涉及 Finder 扩展 + Host + Launcher 的链路，默认加 request 级追踪字段，并在设置读取来源/路由决策/外部进程执行三层打结构化日志。

- 日期：2026-02-27
  - 用户纠正：日志仍显示旧文案，说明实际被点击的 Launcher 不是当前构建产物。
  - 暴露问题：同一 bundle id 在多个 DerivedData 路径并存时，`urlForApplication` 可能命中旧包。
  - 预防规则：解析 Launcher 路径时优先“当前构建同目录”应用，`urlForApplication` 仅作为兜底，并在日志打印最终命中路径。

- 日期：2026-02-27
  - 用户纠正：仅看行为日志不足以判断是否命中正确可执行文件。
  - 暴露问题：缺少启动级元信息（bundlePath/version）会延长定位时间。
  - 预防规则：跨多目标联调时默认在 `applicationDidFinishLaunching` 输出 bundlePath + version，先验证“跑的是哪一个包”再看业务日志。

- 日期：2026-02-27
  - 用户纠正：Launcher 已命中新包但仍使用默认 Terminal，根因是设置读取源只覆盖 sharedFile/userDefaults，未覆盖 Host 容器偏好。
  - 暴露问题：App 沙盒下设置持久化路径与独立 Launcher 读取路径不一致时，会静默回落 `defaultValue`。
  - 预防规则：多进程共享设置必须定义“分层读取顺序”，至少包含 sharedFile + host container preferences 两级，并在日志输出命中源。

- 日期：2026-02-27
  - 用户纠正：终端选择与打开模式不生效，表现为无论选择哪个终端都可能回落系统 Terminal，且 Finder 请求会强制新窗口。
  - 暴露问题：Finder 扩展请求把 `mode` 硬编码为 `newWindow`，同时路由层过早依赖 `isInstalled()` 判定，导致选择链路脆弱。
  - 预防规则：入口请求必须支持“跟随用户默认模式”（`reuseCurrent`），且路由策略应“先尝试用户明确选择，再按错误回退”，不要先验降级。

- 日期：2026-02-27
  - 用户纠正：Warp 选择后仍落回系统 Terminal，核心原因是 Launcher 与主 App 使用了不同设置域。
  - 暴露问题：新增独立 Launcher 后，没有同步校验“设置存储是否跨目标一致”。
  - 预防规则：新增第二个可执行目标时，必须先定义共享配置策略（suite defaults / XPC / App Group）并做端到端验证。

- 日期：2026-02-27
  - 用户纠正：UI 还不够简洁，关键提示不够醒目。
  - 暴露问题：信息层级上“安装限制提示”视觉权重不足，导致用户仍在关键路径上迷惑。
  - 预防规则：涉及系统限制的关键说明默认使用高对比提示容器，并放在主操作按钮正上方。

- 日期：2026-02-27
  - 用户纠正：希望删除冗余调试入口，并在界面直接说明“Finder 工具栏拖拽”这一步是系统限制。
  - 暴露问题：之前功能入口叠加过多，导致核心路径不够简洁，且关键限制信息没有前置。
  - 预防规则：以“首要任务一步完成”为准，默认隐藏非关键操作并把系统限制直接写在主操作区。

- 日期：2026-02-27
  - 实施纠正：对标 Go2Shell 时，单独的 `Launcher` 目标比直接复用设置主 App 更贴近用户体验（避免每次点工具栏都拉起设置窗口）。
  - 暴露问题：如果只做主 App 入口，会在“工具型操作”与“设置型界面”之间产生角色冲突。
  - 预防规则：桌面工具对标时要先拆分“执行器 App（无窗口）”与“设置 App（有窗口）”角色，再决定目标结构。

- 日期：2026-02-27
  - 用户偏好：图标风格希望直接复用参考产品（Go2Shell/Kaku）以快速达到熟悉感。
  - 暴露问题：之前图标是占位素材，和目标产品视觉不一致。
  - 预防规则：视觉对标任务优先复用用户认可的现成资产（在许可范围内），再做品牌化迭代。

- 日期：2026-02-27
  - 实施纠正：Go2Shell 的核心并非 Finder Sync，而是“工具栏 App 图标 + 读取 Finder front window 目录 + `open -a`”。
  - 暴露问题：若只围绕 Finder 扩展实现，会陷入“工具栏点击总是菜单”的体验冲突。
  - 预防规则：对标成熟产品时先解构“主入口链路”，再决定扩展能力放在哪个层级（主入口 vs 备用入口）。

- 日期：2026-02-27
  - 用户纠正：希望“`一键添加到 Finder`”尽量一步到位，不要只给口头说明。
  - 暴露问题：之前仅解释限制，没有把“可自动化的部分（定位 App）”产品化成按钮操作。
  - 预防规则：遇到系统限制时，默认实现“自动完成可做部分 + 明确最后一步提示”，减少纯文档式交付。

- 日期：2026-02-27
  - 用户纠正：现代化 UI 改造偏离预期审美，需要快速回退到可接受的稳定版本。
  - 暴露问题：视觉升级未先给低保真对齐图/风格锚点，导致“做出来再返工”。
  - 预防规则：后续 UI 改造先做可视化方向确认（2-3 个风格关键词 + 一屏草图）再动代码，默认小步迭代。

- 日期：2026-02-27
  - 调研结论：go2shell/openinterminal 的“一步直开”主要依赖 Finder 工具栏 App 图标模式（需拖入工具栏），而非 Finder Sync 工具栏菜单定制。
  - 暴露问题：把 Finder Sync 工具栏当成可完全自定义点击行为，忽略了系统 `menuForMenuKind` 菜单模型边界。
  - 预防规则：涉及 Finder 入口交互时先查官方 API 能力边界，再决定采用 Finder Sync 还是 App 工具栏图标方案。

- 日期：2026-02-27
  - 实施纠正：Finder 工具栏入口即使扩展已注册，也可能因未添加到工具栏或当前目录不在监控范围而“看起来不存在”。
  - 暴露问题：之前联调指引没有明确“运行哪一个 scheme + 如何在 Finder 自定工具栏显示入口”。
  - 预防规则：Finder 联调文档必须固定写明：先运行 `PathBridgeApp`、启用 Finder 扩展、必要时在 Finder 自定工具栏手动拖入入口。

- 日期：2026-02-27
  - 实施纠正：`Apps/PathBridgeApp/Resources/Support/` 下文件在当前 Tuist 配置会被平铺到 `Contents/Resources/` 根目录，不能按 `subdirectory` 读取。
  - 暴露问题：资源路径假设与真实打包产物不一致，导致 `PathBridgeAppTests` 资源断言失败。
  - 预防规则：新增资源后必须先在 `Build/Products/.../Contents/Resources` 核验实际路径，再写 `Bundle` 读取逻辑和测试断言。

- 日期：2026-02-27
  - 用户纠正：Phase 1 终端范围先收敛到 Terminal / iTerm2 / Warp，其他终端分批补齐；UI 以功能对标为先（默认终端、默认参数、感谢支持二维码）。
  - 约束确认：Finder 工具栏“点击即直开”受 Finder Sync 系统限制，需采用“右键主入口直开 + 工具栏最小菜单”合规交互。
  - 预防规则：需求评审时必须先确认“平台能力边界 + 首发功能冻结清单”，避免在实现阶段返工入口交互和范围。

- 日期：2026-02-26
  - 用户纠正：新增必须支持 Kaku 终端；Homebrew 保持第二阶段；不做联网云同步。
  - 暴露问题：前期终端支持列表未一次性冻结，导致后续补充需求。
  - 预防规则：进入方案阶段时先输出“终端兼容矩阵 + 非目标清单”让用户确认，再进入细化设计。

- 日期：2026-02-26
  - 用户纠正：Finder 入口优先级改为“工具栏优先”；跨目录多选默认“多窗口”；发布工作后置到联调/自测后。
  - 暴露问题：交互默认值和发布节奏未在第一轮方案中显式冻结。
  - 预防规则：在方案评审时必须单列“默认交互值 + 发布门禁”并让用户确认。

- 日期：2026-02-26
  - 文档审计发现：跨文档存在细节漂移（如 Bundle ID、Phase 1/Phase 2 边界、命令安全表述）。
  - 暴露问题：缺少统一的“事实源”导致规格细节不一致。
  - 预防规则：关键事实（Bundle ID、安装命令、发布阶段边界）集中维护在矩阵/清单文档，并在每轮修订后做一致性检查。

- 日期：2026-02-26
  - 实施阶段发现：工作目录位于上层 Git 仓库中，存在误提交风险。
  - 暴露问题：项目初始化时未先确认仓库边界。
  - 预防规则：开工前固定执行 `git rev-parse --show-toplevel`，如不匹配项目目录则先初始化独立仓库。

- 日期：2026-02-26
  - 用户纠正：按先前指引操作后仍找不到 Finder 扩展开关与入口。
  - 暴露问题：仅给了 UI 操作步骤，未先验证扩展是否完成系统注册（`pluginkit`）与签名前置条件。
  - 预防规则：所有 Finder 扩展联调指导必须先执行三项检查：`appex` 是否内嵌、`entitlements` 是否存在、`pluginkit -m -p com.apple.FinderSync` 是否可见。
