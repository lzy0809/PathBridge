# go2shell Pro 交互规格（Phase 1）

## 1. 入口与信息架构
支持 3 个 Finder 入口：
- 工具栏按钮（最高优先级，首发必须）。
- 右键菜单（第二优先级，作为补充入口）。
- 服务菜单（可选，Phase 1 末尾评估）。

### 1.1 工具栏主菜单结构
菜单在每次展开时动态生成，仅显示已安装的终端：

```
┌─ Open in go2shell Pro ─────────────┐  ← 默认动作（使用偏好设置中的默认终端）
├─ Open in... ───────────────────────┤
│   ├─ Terminal                      │  ← 仅已安装的终端显示
│   ├─ iTerm2                        │
│   ├─ Warp                          │
│   └─ ...（其他已安装终端）           │
├─ Open With Command... ─────────────┤  ← 使用自定义启动命令打开
└─────────────────────────────────────┘
```

**菜单动态规则：**
- 终端检测时机：菜单展开时实时检测（缓存 30 秒避免频繁 IO）
- 未安装终端：不在 `Open in...` 子菜单中显示（隐藏而非灰显）
- 异常兜底：若检测异常导致无终端可用，`Open in...` 子菜单灰显并提示"未检测到支持的终端"
- 最低保障：macOS 自带 Terminal 始终可用，作为兜底

### 1.2 右键菜单（次优先）
- 保留 `Open in go2shell Pro` 快捷入口，行为与工具栏默认动作一致
- 右键菜单同样遵循动态检测规则

## 2. 选择规则与行为定义
Finder 选择解析优先级：
1. `selectedItemURLs()` 非空则使用选中项。
2. 否则使用 `targetedURL()`（当前目录）。

路径归一化规则：
- 选中文件：自动取父目录。
- 选中目录：直接使用目录。
- 多选同目录：默认聚合成单目录打开一次。
- 多选跨目录：默认“多窗口”；用户可在设置中改为“多标签”或“合并”。

## 3. 交互反馈
成功反馈：
- 默认静默成功（不弹窗）。
- 可选调试模式显示通知：`Opened in iTerm2: ~/project`。

失败反馈（必须可见）：
- 终端未安装：`Kaku 未安装，已回退到默认终端`。
- 无法访问路径：`路径无访问权限`。
- 自动化失败（Apple Events）：提示引导到系统设置授权。

## 4. 偏好设置页（主应用）

### 4.1 General
- **默认终端**（下拉，仅列出已安装的终端）
- **默认动作**：新窗口 / 新标签 / 当前窗口
- **打开后激活到前台**：是/否

### 4.2 Commands（启动命令配置）

**默认启动命令：**
```
cd %PATH_QUOTED%; clear; pwd
```

**支持的占位符：**

| 占位符 | 说明 | 示例值 |
|--------|------|--------|
| `%PATH%` | 目标目录的完整路径 | `/Users/foo/projects/myapp` |
| `%PATH_QUOTED%` | 带引号的路径（处理空格） | `"/Users/foo/my project"` |
| `%DIRNAME%` | 目录名称 | `myapp` |
| `%USER%` | 当前用户名 | `foo` |
| `%HOME%` | 用户主目录 | `/Users/foo` |

**命令模板示例：**
```bash
# 基础用法
cd %PATH_QUOTED%; clear; pwd

# 开发场景
cd %PATH_QUOTED%; source .env && npm run dev

# Python 项目
cd %PATH_QUOTED%; source venv/bin/activate && python main.py

# Git 快速查看
cd %PATH_QUOTED%; git status -s

# 复杂场景
cd %PATH_QUOTED%; clear; echo "=== %DIRNAME% ===" && pwd && git branch --show-current
```

**安全限制（修订）：**
- 命令模板默认关闭，首次启用必须二次确认风险。
- 黑名单仅用于风险提示，不作为安全边界（不能依赖黑名单实现真正防护）。
- 执行前统一展示解析后的最终命令（Debug 模式必显）。
- 命令模板存储在本地，不上传云端。

### 4.3 Advanced
- **多选策略**：多窗口 / 合并 / 多标签
- **回退策略**：目标终端失败后是否自动回退默认终端
- **调试模式**：开启后显示操作通知

### 4.4 Diagnostics
- 最近 100 条执行日志
- 一键导出诊断包（本地）

## 5. 新手引导
首次启动引导 3 步：
1. 开启 Finder 扩展。
2. 选择默认终端。
3. 执行一次“测试打开”验证链路。

## 6. 可用性指标（Phase 1）
- P95 从点击菜单到终端可用 < 1000ms。
- 关键失败场景均有明确文案与可操作建议。
- 三步内完成首次可用配置。
